{% block content %}



{% set tags = craft.entries()
    .section('genstag')
    .gens(user)
    .limit(99)
    .orderBy('dateCreated DESC')
    .all() %}


{# On garde le même début pour trier la liste chronologiquement #}
{% set currentHour = now|date('G', 'Europe/Paris') %}
{% set upcomingItems = [] %}
{% set pastItems = [] %}

{% for item in tags %}
    {% set itemHour = item.dt|date('G') %}
    {% if itemHour >= currentHour %}
        {% set upcomingItems = upcomingItems|merge([item]) %}
    {% else %}
        {% set pastItems = pastItems|merge([item]) %}
    {% endif %}
{% endfor %}

{% set upcomingItems = upcomingItems|sort((a, b) => a.dt <=> b.dt) %}
{% set pastItems = pastItems|sort((a, b) => a.dt <=> b.dt) %}
{% set sortedAgenda = upcomingItems|merge(pastItems) %}

{# NOUVELLE PARTIE : On groupe les items triés par heure #}
{% set groupedAgenda = sortedAgenda|group(item => item.dt|date('H')) %}


{# --- AFFICHAGE REGROUPÉ --- #}
{# On boucle sur les heures (les clés du groupe) #}
{% for hour, itemsInHour in groupedAgenda %}
    {# On affiche l'heure une seule fois #}
    <a href="h/{{ hour }}"><h3 class="btn btn-outline-secondary">{{ hour }}h </h3></a>
    
    <div>
        {# Puis on boucle sur les items de cette heure #}
        {% for item in itemsInHour %}
            <div class=" card-body" style="border-left: solid;
    padding: 10px;
    border-radius: 15px;">
                <div class="card card-body border-secondary">
                    <span><small>Objectif de {{hour}}h : </small></span>
                    <b><h3>{{ item.tagg[0].title }}</b><a href="/o/{{ item.tagg[0].id }}"><button class="btn btn-light m-1" style="font: small-caption;">VOIR</button></h3></a>
                    <small><b>{{ item.title }}</b></small>                 
                </div>

                <br>
                {% include "debout/accueil/listVers.twig" with {
                        tag: item,
                        user: user
                    } %}   



                <br>
                <div class="card card-body border-secondary" style="display:block;">
                    {% include "debout/accueil/createTache.twig" with {
                        tagg:item.tagg[0],
                        user:user
                    } %}
                </div>




                {# <br>
                {% include "debout/accueil/listVersOR.twig" with {
                    tag: item,
                    user: user
                } %} #}
            </div>
            <br>
        {% endfor %}
    </div>
{% endfor %}




{% endblock %}

