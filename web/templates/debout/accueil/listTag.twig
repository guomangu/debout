{% block content %}



{% set tags = craft.entries()
    .section('genstag')
    .gens(user)
    .groupe(':empty:') 
    .limit(99)
    .orderBy('dateCreated DESC')
    .all() %}


{# On garde le même début pour trier la liste chronologiquement #}
{% set currentHour = now|date('G', 'Europe/Paris') %}
{% set upcomingItems = [] %}
{% set pastItems = [] %}

{% for item in tags %}
    {% set itemHour = item.dt|date('G') %}
    {% if itemHour >= currentHour %}
        {% set upcomingItems = upcomingItems|merge([item]) %}
    {% else %}
        {% set pastItems = pastItems|merge([item]) %}
    {% endif %}
{% endfor %}

{% set upcomingItems = upcomingItems|sort((a, b) => a.dt <=> b.dt) %}
{% set pastItems = pastItems|sort((a, b) => a.dt <=> b.dt) %}
{% set sortedAgenda = upcomingItems|merge(pastItems) %}

{# NOUVELLE PARTIE : On groupe les items triés par heure #}
{% set groupedAgenda = sortedAgenda|group(item => item.dt|date('H')) %}


{# --- AFFICHAGE REGROUPÉ --- #}
{# On boucle sur les heures (les clés du groupe) #}

{% if groupedAgenda is empty %}<h3 class="text-center">Agenda vide</h3>{% endif %}
{% for hour, itemsInHour in groupedAgenda %}
    {# On affiche l'heure une seule fois #}
    <a href="/h/{{ hour }}" style="text-decoration-line: none; color:black;"><h1 class="card card-body">{{ hour }}h </h1></a>
    
    <div>
        {# Puis on boucle sur les items de cette heure #}
        {% for item in itemsInHour %}
            <div class=" card-body" style="border-left: solid;
            padding: 10px;
            border-radius: 15px;">
                <div class="card card-body" style=" background-color:#00000012;">
                    <span><small>Objectif de {{hour}}h : </small></span>
                    <b><h3>{{ item.tagg[0].title|capitalize  }}</b><a href="/o/{{ item.tagg[0].id }}"><button class="btn btn-outline-secondary m-1" style="font: small-caption;">VOIR</button></h3></a>
                    <small><b>{{ item.title|capitalize  }}</b></small>
                    <br>
                    {% include "debout/accueil/createVers.twig" with {
                            tag:item,
                            user:user
                        }
                    %}      




                    <br>
                    {% include "debout/accueil/listValide.twig" with {
                        genstag: item,
                        user: user
                    } %}           
                </div>

                <br>
                {% include "debout/accueil/listVers.twig" with {
                    tag: item,
                    user: user
                } %}   



                {# <br>
                <div class="card card-body border-secondary" style="display:block;">
                    {% include "debout/accueil/createTache.twig" with {
                        tagg:item.tagg[0],
                        user:user
                    } %}
                </div> #}




                {# <br>
                {% include "debout/accueil/listVersOR.twig" with {
                    tag: item,
                    user: user
                } %} #}
            </div>
            <br>
        {% endfor %}
    </div>

<div style="place-self: center;" onclick="document.getElementById('agendaaa').scrollIntoView({behavior: 'smooth'});">
    <svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" fill="currentColor" class="bi bi-chevron-double-up" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M7.646 2.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 3.707 2.354 9.354a.5.5 0 1 1-.708-.708z"/>
        <path fill-rule="evenodd" d="M7.646 6.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 7.707l-5.646 5.647a.5.5 0 0 1-.708-.708z"/>
    </svg>
</div>
{% endfor %}




{% endblock %}

